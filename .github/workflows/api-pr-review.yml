name: AI PR Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  ai_review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Fetch PR Diff
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          git diff origin/${{ github.event.pull_request.base.ref }} HEAD > pr_diff.txt

      - name: Debug PR Diff Content
        run: |
          echo "üîç PR Diff Content:"
          cat pr_diff.txt || echo "‚ö†Ô∏è No changes detected in diff!"

      - name: Call OpenAI for Review
        id: ai_review
        shell: bash
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # Ensure pr_diff.txt exists and is not empty
          if [ ! -f pr_diff.txt ] || [ ! -s pr_diff.txt ]; then
            echo "‚ö†Ô∏è No code changes detected in PR or pr_diff.txt is missing. Skipping AI review."
            exit 0
          fi

          # Read and escape PR diff content properly
          DIFF_CONTENT=$(jq -Rs '.' < pr_diff.txt)

          # Construct the JSON payload safely using jq
          JSON_PAYLOAD=$(jq -n --arg diff "$DIFF_CONTENT" '{
            "model": "gpt-4-turbo",
            "messages": [
              { "role": "system", "content": "You are an expert code reviewer. Analyze the given code diff and provide structured inline comments in JSON format with 'file', 'line', and 'comment' fields." },
              { "role": "user", "content": ("Here is the code diff:\n" + $diff + "\nPlease review and provide comments.") }
            ],
            "max_tokens": 1000,
