name: AI PR Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  ai_review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Fetch PR Diff
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          git diff origin/${{ github.event.pull_request.base.ref }} HEAD > pr_diff.txt

      - name: Debug PR Diff Content
        run: |
          echo "ðŸ” PR Diff Content:"
          cat pr_diff.txt || echo "âš ï¸ No changes detected in diff!"

      - name: Call OpenAI for Review
      id: ai_review
      run: |
      DIFF_CONTENT=$(cat pr_diff.txt | jq -Rs .) # Convert text to valid JSON string

    RESPONSE=$(curl -s -X POST "https://api.openai.com/v1/chat/completions" \
      -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
      -H "Content-Type: application/json" \
      -d "{
        \"model\": \"gpt-4\",
        \"messages\": [
          {\"role\": \"system\", \"content\": \"You are an expert code reviewer. Analyze the given code diff and provide constructive feedback, highlighting potential issues, improvements, and best practices.\"},
          {\"role\": \"user\", \"content\": \"Here is the code diff:\n${DIFF_CONTENT} Please review and provide comments.\"}
        ]
      }")

    echo "ðŸ” OpenAI Full Response: $RESPONSE" # Debugging: print full API response

    REVIEW_COMMENT=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')

    if [ -z "$REVIEW_COMMENT" ] || [ "$REVIEW_COMMENT" = "null" ]; then
      REVIEW_COMMENT="ðŸ¤– AI Review: No comments were generated. Please check the input or refine the prompt."
    fi

    echo "$REVIEW_COMMENT" > review_comment.txt
    echo "::set-output name=review::$REVIEW_COMMENT"


      - name: Post AI Review as PR Comment
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: |
            **ðŸ¤– AI Code Review:**
            ${{ steps.ai_review.outputs.review }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
